<!DOCTYPE html>
<meta charset="utf-8">
<html>

<body>
    <div class="jumbotron text-center">
        <h1>Italian politicians tweets visualization</h1>

    </div>
    <div class="card shadow-lg p-3">
        <div class="row text-center">
            <div class="col-sm">
                <p>Instructions </p>
            </div>
            <div class="col-sm">
                <div class="form-group">
                    <label>Select the first politician</label>
                    <select class="form-control" id="firstPoliticiansSelect">
                        <option>--</option>
                    </select>
                </div>
            </div>
            <div class="col-sm">
                <div class="form-group">
                    <label>Select the second politician</label>
                    <select class="form-control" id="secondPoliticiansSelect">
                        <option>--</option>
                    </select>
                </div>
            </div>
            <div class="col-sm">
                <button id="primaryButton" type="button" class="btn btn-primary">Go!</button>
                <button id="cancelButton" type="button" class="btn btn-danger">Cancel</button>
            </div>
        </div>
    </div>
    <div id="card" class="card shadow-lg p-3 d-none">
        <svg id="svg">

        </svg>
    </div>
    <div id="tweetsContainers" class="allTweet">
        <div id="leftTweetContainer" class="card shadow-lg p-3 leftTweet d-none">
            <div id="leftProfilePoliticianContainer"></div>
            <div id="leftTweetsPoliticianContainer"></div>
        </div>
        <div id="rightTweetContainer" class="card shadow-lg p-3 rightTweet d-none ">
            <div id="rightProfilePoliticianContainer"></div>
            <div id="rightTweetsPoliticianContainer"></div>
        </div>

</body>

</html>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://d3js.org/d3.v5.js"></script>
<script src="node-pie.js"></script>
<script>

    document.getElementById("cancelButton").disabled = true;

    var firstColor = "rgb(0, 132, 180)"
    var secondColor = "rgb(255, 153, 0)"
    var serverName = "http://localhost:8000"


    function cleanTwitterEnbeddedTweets() {
        document.getElementById("leftTweetsPoliticianContainer").innerHTML = ""
        document.getElementById("rightTweetsPoliticianContainer").innerHTML = ""
    }

    function cleanTwitterEnbeddedProfiles() {
        document.getElementById("leftProfilePoliticianContainer").innerHTML = ""
        document.getElementById("rightProfilePoliticianContainer").innerHTML = ""
    }

    function addClipPath(imageRadius) {
        var svgElement = document.getElementById("svg")
        svgElement.innerHTML = "<clipPath id='clipCircle'> <circle r=" + imageRadius + " cx=" + imageRadius / 2 + " cy=" + imageRadius / 2 + " /> </clipPath>"
    }

    function fromWidthCardToImageRadius(widthCard) {
        return widthCard / 20;
    }
    function sumRatiosPolitician(d, name1, name2) {
        let sum = (parseFloat(d.politicians[name1]["ratio"]) + parseFloat(d.politicians[name2]["ratio"]));
        //console.log("summing result", sum)
        return sum;
    }

    function fromSumToSize(sum) {
        return sum * 2500 + 15
    }
    // First, load the widgets.js file asynchronously
    window.twttr = (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0],
            t = window.twttr || {};
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);

        t._e = [];
        t.ready = function (f) {
            t._e.push(f);
        };

        return t;
    }(document, "script", "twitter-wjs"));

    fetch(serverName + "/d3/politicians.json")
        .then(function (response) {
            return response.json();
        })
        .then(function (objectPoliticians) {
            var index = 0;
            let firstPoliticiansSelect = document.getElementById("firstPoliticiansSelect");
            let secondPoliticiansSelect = document.getElementById("secondPoliticiansSelect");
            for (var key in objectPoliticians) {
                var opt1 = document.createElement("option");
                var opt2 = document.createElement("option");
                opt1.value = index;
                opt1.innerHTML = key;
                opt2.value = index;
                opt2.innerHTML = key;
                // then append it to the select element
                firstPoliticiansSelect.appendChild(opt1);
                secondPoliticiansSelect.appendChild(opt2);
                index++;
            }

            var primaryButton = document.getElementById("primaryButton")
            primaryButton.onclick = function () {
                document.getElementById("card").classList.remove("d-none");
                
                var widthCard = document.getElementById("card").clientWidth - 30
                console.log(document.getElementById("card").clientWidth)
                var heightCard = window.innerHeight * 0.6
                var imageRadius = fromWidthCardToImageRadius(widthCard);
                var xOffSet = imageRadius * 1.9;

                addClipPath(imageRadius)

                let firstPoliticiansSelect = document.getElementById("firstPoliticiansSelect");
                let secondPoliticiansSelect = document.getElementById("secondPoliticiansSelect");
                //chech if different 
                var firstSelected = firstPoliticiansSelect.options[firstPoliticiansSelect.selectedIndex].text;
                var secondSelected = secondPoliticiansSelect.options[secondPoliticiansSelect.selectedIndex].text;
                console.log(firstSelected + " " + secondSelected)

                var svg = document.getElementById('svg');
                svg.setAttribute("width", widthCard)
                svg.setAttribute("height", heightCard)

                //create somewhere to put the force directed graph
                var svg = d3.select("svg"),
                    width = +svg.attr("width"),
                    height = +svg.attr("height");


                d3.json(serverName + "/d3/politiciansNEW.json").then(function (graph) {
                    //set up the simulation and add forces

                    graph.nodes.push(
                        {
                            "id": firstSelected,
                            "color": objectPoliticians[firstSelected]["color"],
                            "isTopic": 0,
                            "side": "left"
                        }
                    )

                    graph.nodes.push(
                        {
                            "id": secondSelected,
                            "color": objectPoliticians[secondSelected]["color"],
                            "isTopic": 0,
                            "side": "right"
                        }
                    )

                    var simulation = d3.forceSimulation(graph.nodes)
                    simulation
                        .alpha(0.2)
                        .force("charge", d3.forceManyBody().strength(-3000))
                        .force('collision', d3.forceCollide().radius(function (d) {
                            if (d.isTopic == 1) {
                                return fromSumToSize(sumRatiosPolitician(d, firstSelected, secondSelected))
                            }
                            else {
                                return imageRadius
                            }
                        }))
                        .force("xCenter", d3.forceX().x(widthCard / 2).strength(function (d) {
                            if (d.isTopic == 1) {
                                return sumRatiosPolitician(d, firstSelected, secondSelected) * 35 + 0.1
                                //return 0.6
                            }
                            else {
                                return 0
                            }
                        }))
                        .force("yCenter", d3.forceY().y(heightCard / 2).strength(function (d) {
                            if (d.isTopic == 1) {
                                return sumRatiosPolitician(d, firstSelected, secondSelected) * 35 + 0.3
                                //return 0.8
                            }
                            else {
                                return 1
                            }
                        }))

                        .force('xLeft', d3.forceX()
                            .x(xOffSet).strength(function (d) {
                                if (d.isTopic == 1) {
                                    return (d.politicians[firstSelected]["ratio"] * 100)
                                }
                                else {
                                    if (d.side == "left") {
                                        return 1
                                    }
                                    else {
                                        return 0
                                    }
                                }
                            }))
                        .force('xRigth', d3.forceX()
                            .x(width - xOffSet - imageRadius).strength(function (d) {
                                if (d.isTopic == 1) {
                                    return (d.politicians[secondSelected]["ratio"] * 100)
                                }
                                else {
                                    if (d.side == "left") {
                                        return 0
                                    }
                                    else {
                                        return 1
                                    }
                                }
                            }))

                    //add tick instructions:
                    simulation.on("tick", tickActions);
                    //add encompassing group for the zoom
                    var g = svg.append("g")
                        .attr("class", "everything");

                    //draw circles for the nodes
                    var node = g.selectAll('.nodes')
                        .data(graph.nodes)
                        .enter()
                        .append('g')
                        .attr('class', 'nodes')

                    node.each(function (singleNode) {
                        if (singleNode.isTopic == 1) {
                            var percentage = []
                            var sum = sumRatiosPolitician(singleNode, firstSelected, secondSelected)
                            if (sum > 0) {
                                percentage.push({ "politic": firstSelected, "percent": Math.round(singleNode.politicians[firstSelected]["ratio"] / sum * 100), "color": firstColor })
                                percentage.push({ "politic": secondSelected, "percent": Math.round(singleNode.politicians[secondSelected]["ratio"] / sum * 100), "color": secondColor })

                                NodePieBuilder.drawNodePie(d3.select(this), percentage, {
                                    parentNodeColor: "#FFFF00",
                                    outerStrokeWidth: 30,
                                    radius: fromSumToSize(sum),
                                    showLabelText: true,
                                    labelText: singleNode.id,
                                    labelColor: "blue"
                                });
                            }
                            var nodeEnter = d3.select(this);
                            nodeEnter.on("click", function (clickedNode) {
                                document.getElementById("leftTweetContainer").classList.remove("d-none");
                                document.getElementById("rightTweetContainer").classList.remove("d-none");
                                cleanTwitterEnbeddedProfiles();
                                cleanTwitterEnbeddedTweets();
                                var numberTweets = 5
                                document.getElementById("leftTweetsPoliticianContainer").innerHTML = "Tweets in which " + firstSelected + " deals with the topic " + clickedNode.id + ": <br>"
                                document.getElementById("rightTweetsPoliticianContainer").innerHTML = "Tweets in which " + secondSelected + " deals with the topic " + clickedNode.id + ": <br>"
                                for (var i = 0; i < numberTweets; i++) {
                                    twttr.widgets.createTweet(
                                        clickedNode.politicians[firstSelected]["tweet_ids"][i],
                                        document.getElementById("leftTweetsPoliticianContainer"),
                                        {
                                            width: widthCard * 0.3,
                                            height: '700',
                                            related: 'twitterdev,twitterapi'
                                        }).then(function (el) {
                                            console.log('Embedded a timeline.')
                                        });
                                    twttr.widgets.createTweet(
                                        clickedNode.politicians[secondSelected]["tweet_ids"][i],
                                        document.getElementById("rightTweetsPoliticianContainer"),
                                        {
                                            width: widthCard * 0.3,
                                            height: '700',
                                            related: 'twitterdev,twitterapi'
                                        }).then(function (el) {
                                            console.log('Embedded a timeline.')
                                        });
                                }
                            })
                            /*nodeEnter.on('mouseenter', function (d) {
                                // select element in current context
                                console.log(d)
                                console.log(d3.select(this))
                                d3.select(this)
                                    .transition()
                                    .attr("transform","scale(4)");
                            })
                            // set back
                            nodeEnter.on('mouseleave', function () {
                                console.log('mouseleave')
                                d3.select(this)
                                    .transition()
                                    .attr("transform","scale("+fromSumToSize(sum)/2+","+fromSumToSize(sum)/2+",-4)");
                            });*/

                        }

                        else {
                            //Not topics so photo of politician
                            var nodeEnter = d3.select(this);

                            nodeEnter.append("circle")
                                .attr("r", imageRadius + 10)
                                .attr("cx", imageRadius / 2)
                                .attr("cy", imageRadius / 2)
                                .attr("fill", function (d) {
                                    if (d.side == "left") {
                                        return objectPoliticians[firstSelected].color
                                    }
                                    else {
                                        return objectPoliticians[secondSelected].color
                                    }
                                })
                            nodeEnter.append("svg:image")

                                .attr("xlink:href", function (d) {
                                    if (d.side == "left") {
                                        return objectPoliticians[firstSelected].photo;
                                    }
                                    else {
                                        return objectPoliticians[secondSelected].photo
                                    }
                                })
                                .attr("clip-path", "url(#clipCircle)")
                                .attr("x", function (d) { return -imageRadius / 2 - 40 })
                                .attr("y", function (d) { return -imageRadius / 2 })
                                .attr("height", imageRadius * 2.8)
                                .attr("width", imageRadius * 3.1)

                            nodeEnter.append("text")
                                .text(function (d) { return (d.id) })
                                .attr("fill", function (d) { return (d.color) })
                                .attr("dy", imageRadius * 1.9 + 20);

                            nodeEnter.on("click",
                                function (clickedNode) {
                                    cleanTwitterEnbeddedTweets();
                                    if (clickedNode.id == firstSelected) {
                                        document.getElementById("leftTweetContainer").classList.remove("d-none");
                                        if (document.getElementById("rightProfilePoliticianContainer").innerHTML == ""){
                                            document.getElementById("rightTweetContainer").classList.add("d-none");
                                        }
                                        document.getElementById("leftProfilePoliticianContainer").innerHTML = "Twitter timeline of " + firstSelected + ": <br>"
                                        twttr.widgets.createTimeline(
                                            {
                                                sourceType: 'profile',
                                                screenName: objectPoliticians[firstSelected]["twetterName"]
                                            },
                                            document.getElementById("leftProfilePoliticianContainer"),
                                            {
                                                width: widthCard * 0.3,
                                                height: '700',
                                                related: 'twitterdev,twitterapi'
                                            }).then(function (el) {
                                                console.log('Embedded a timeline.')
                                            });
                                    }
                                    else {
                                        document.getElementById("rightTweetContainer").classList.remove("d-none");
                                        if (document.getElementById("leftProfilePoliticianContainer").innerHTML == ""){
                                            document.getElementById("leftTweetContainer").classList.add("d-none");
                                        }
                                        document.getElementById("rightProfilePoliticianContainer").innerHTML = "Twitter timeline of " + secondSelected + ": <br>"
                                        twttr.widgets.createTimeline(
                                            {
                                                sourceType: 'profile',
                                                screenName: objectPoliticians[secondSelected]["twetterName"]
                                            },
                                            document.getElementById("rightProfilePoliticianContainer"),
                                            {
                                                width: widthCard * 0.3,
                                                height: '700',
                                                related: 'twitterdev,twitterapi'
                                            }).then(function (el) {
                                                console.log('Embedded a timeline.')
                                            });
                                    }
                                }
                            )
                        }
                    });

                    //console.log(node);
                    //add drag capabilities
                    var drag_handler = d3.drag()
                        .on("start", drag_start)
                        .on("drag", drag_drag)
                        .on("end", drag_end);

                    drag_handler(node);


                    //add zoom capabilities
                    var zoom_handler = d3.zoom()
                        .on("zoom", zoom_actions);

                    zoom_handler(svg);

                    /** Functions **/

                    //Drag functions
                    //d is the node
                    function drag_start(d) {
                        if (!d3.event.active) simulation.alphaTarget(0.01).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    }

                    //make sure you can't drag the circle outside the box
                    function drag_drag(d) {
                        d.fx = d3.event.x;
                        d.fy = d3.event.y;
                    }

                    function drag_end(d) {
                        if (!d3.event.active) simulation.alphaTarget(0.01);
                        d.fx = null;
                        d.fy = null;
                    }

                    //Zoom functions
                    function zoom_actions() {
                        //Zoom limits
                        console.log(d3.event.transform)
                        if (d3.event.transform.k < 1.5) {
                            if (d3.event.transform.k > 0.5) {
                                g.attr("transform", d3.event.transform)
                            }
                            else {
                                d3.event.transform.k = 0.51
                            }

                        }
                        else {
                            d3.event.transform.k = 1.49
                        }
                    }

                    function tickActions() {
                        //update circle positions each tick of the simulation
                        node.attr('transform', d => `translate(${d.x},${d.y})`);
                    }
                    document.getElementById("primaryButton").disabled = true;
                    document.getElementById("cancelButton").disabled = false;
                })
                    .catch(function (error) {
                        console.log("ERROR!", error)
                    });
            }

            var cancelButton = document.getElementById("cancelButton")

            cancelButton.onclick = function () {
                //Initial state
                document.getElementById("svg").innerHTML = ""
                document.getElementById("card").classList.add("d-none");
                document.getElementById("leftTweetContainer").classList.add("d-none");
                document.getElementById("rightTweetContainer").classList.add("d-none");
                document.getElementById("primaryButton").disabled = false;
                document.getElementById("cancelButton").disabled = true;
                cleanTwitterEnbeddedTweets();
                cleanTwitterEnbeddedProfiles();
            }

        });


</script>